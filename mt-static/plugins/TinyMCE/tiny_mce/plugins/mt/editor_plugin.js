!function($){$.each(["plugin","advanced","core"],function(){tinymce.ScriptLoader.add(tinymce.PluginManager.urls.mt+"/langs/"+this+".js")}),tinymce.Editor.prototype.addMTButton=function(name,opts){var ed=this,modes={},funcs=opts.onclickFunctions;if(funcs)for(k in opts.onclick=function(){var mode=ed.mtEditorStatus.mode,func=funcs[mode];"string"==typeof func?ed.mtProxies[mode].execCommand(func):func.apply(ed,arguments),"source"==mode&&ed.onMTSourceButtonClick.dispatch(ed,ed.controlManager)},funcs)modes[k]=1;else modes={wysiwyg:1,source:1};return opts.isSupported||(opts.isSupported=function(mode,format){if(!modes[mode])return!1;if(funcs&&"source"==mode){var func=funcs[mode];return"string"!=typeof func||ed.mtProxies.source.isSupported(func,format)}return!0}),"undefined"==typeof ed.mtButtons&&(ed.mtButtons={}),ed.mtButtons[name]=opts,ed.addButton(name,opts)},tinymce.create("tinymce.ui.MTTextButton:tinymce.ui.Button",{renderHTML:function(){var h,l,DOM=tinymce.DOM,cp=this.classPrefix,s=this.settings;return l=DOM.encode(s.label||""),h='<a role="button" id="'+this.id+'" href="javascript:;" class="mceMTTextButton '+cp+" "+cp+"Enabled "+s["class"]+(l?" "+cp+"Labeled":"")+'" onmousedown="return false;" onclick="return false;" aria-labelledby="'+this.id+'_voice" title="'+DOM.encode(s.title)+'">',h+=s.text,h+="</a>"}}),tinymce.create("tinymce.plugins.MovableType",{buttonSettings:"",_initButtonSettings:function(ed){var plugin=this;plugin.buttonIDs={};var buttonRows={source:{},wysiwyg:{}},index=1;return $.each(["common","source","wysiwyg"],function(i,k){for(var p="plugin_mt_"+k+"_buttons",j=1;ed.settings[p+j];j++)plugin.buttonSettings+=(plugin.buttonSettings?",":"")+ed.settings[p+j],ed.settings["theme_advanced_buttons"+index]=ed.theme.settings["theme_advanced_buttons"+index]=ed.settings[p+j],"common"==k?buttonRows.source[index-1]=buttonRows.wysiwyg[index-1]=1:buttonRows[k][index-1]=1,index++}),buttonRows},_setupIframeStatus:function(ed){ed.onPostRender.add(function(){var $win=$(window),$iframe=$(ed.getContainer()).find("iframe"),$iframeWin=$(ed.getWin()),ns=".tinymce_mt_iframe_status_"+ed.id;$iframeWin.focus(function(){$iframe.addClass("state-focus")}).blur(function(){$iframe.removeClass("state-focus")}),function bindMousemoveToIframe(){$iframeWin.bind("mousemove"+ns,function(){$iframeWin.unbind("mousemove"+ns),$iframe.addClass("state-hover"),$win.bind("mousemove"+ns,function(){$win.unbind("mousemove"+ns),$iframe.removeClass("state-hover"),bindMousemoveToIframe()})})}()})},_setupExplicitButtonActivation:function(ed){ed.onPostRender.add(function(){var win=window,button="$TinyMCEMTButtonActive";$(ed.getContainer()).find(".mceButton, .mceListBoxEnabled, .mceSplitButtonEnabled a").mousedown(function(){win[button]=$(this).addClass("psedo-active")}),$.each([win.document,ed.getWin().document],function(){var ns=".tinymce_mt_button_activate",event="mouseup"+ns+" touchend"+ns;$(this).unbind(event).bind(event,function(){win[button]&&(win[button].removeClass("psedo-active"),win[button]=null)})})})},init:function(ed,url){var plugin=this,id=ed.id,idLengbth=id.length,blogId=$("#blog-id").val()||0,proxies={},hiddenControls=[],$container=null,savedBookmark=null,supportedButtonsCache={},buttonRows=this._initButtonSettings(ed),sourceButtons={};function updateButtonVisibility(){var s=ed.mtEditorStatus;$.each(hiddenControls,function(i,k){$container.find(".mce_"+k).css({display:""}).removeClass("mce_mt_button_hidden"),ed.controlManager.setDisabled(this,!1)}),hiddenControls=[];var supporteds=function supportedButtons(mode,format){var k=mode+"-"+format;return supportedButtonsCache[k]||(supportedButtonsCache[k]={},$.each(ed.mtButtons,function(name,button){button.isSupported(mode,format)&&(supportedButtonsCache[k][name]=button)})),supportedButtonsCache[k]}(s.mode,s.format);function update(key){supporteds[key]||($container.find(".mce_"+key).css({display:"none"}).addClass("mce_mt_button_hidden"),hiddenControls.push(key))}"source"==s.mode?(proxies.source.setFormat(s.format),$.each(ed.controlManager.controls,function(k,c){c.classPrefix&&update(k.substr(idLengbth+1))})):$.each(ed.mtButtons,function(name,button){update(name)}),$("#"+id+"_toolbargroup > span > table").each(function(i){buttonRows[s.mode][i]?$(this).show():$(this).hide()})}function openDialog(mode,param){createSessionHistoryFallback(location.href),$.fn.mtDialog.open(ScriptURI+"?__mode="+mode+"&amp;"+param)}function setPopupWindowLoadedHook(callback){$.each(ed.windowManager.windows,function(k,w){var iframe=w.iframeElement;$("#"+iframe.id).load(function(){var win=this.contentWindow,context={$contents:$(this).contents(),window:win};callback(context,function(){win.tinyMCEPopup.close(),tinymce.isWebKit&&$("#convert_breaks").focus(),proxies.source.focus()})})})}function mtSourceLinkDialog(c,close){c.$contents.find("form").attr("onsubmit","").submit(function onSubmit(){var $form=$(this);proxies.source.execCommand("createLink",null,$form.find("#href").val(),{target:$form.find("#target_list").val(),title:$form.find("#linktitle").val()}),close()}),proxies.source.isSupported("createLink",ed.mtEditorStatus.format,"target")||c.$contents.find("#targetlistlabel").closest("tr").hide()}function mtSourceTemplateDialog(c,close){function insertContent(ed,cmd,ui,val,a){"mceInsertContent"==cmd&&(proxies.source.editor.insertContent(val),a.terminate=!0)}function onSubmit(){ed.onBeforeExecCommand.add(insertContent),c.window.TemplateDialog.insert(),ed.onBeforeExecCommand.remove(insertContent)}setTimeout(function(){c.$contents.find("form").attr("onsubmit","").submit(onSubmit)},0)}function updateSourceButtonState(ed,cm){$.each(sourceButtons,function(k,command){cm.setActive(k,ed.mtProxies.source.isStateActive(command))})}ed.mtProxies=proxies,ed.mtEditorStatus={mode:"wysiwyg",format:"richtext"},ed.onInit.add(function(){$container=$(ed.getContainer()),updateButtonVisibility(),function initSourceButtons(){$.each(ed.mtButtons,function(name,button){var command;button.onclickFunctions&&(command=button.onclickFunctions.source)&&"string"==typeof command&&-1!=plugin.buttonSettings.indexOf(name)&&(sourceButtons[name]=command)})}(),ed.theme.resizeBy(0,0),function insertContentSecurityPolicy(){var win=ed.getWin(),csp=win.document.createElement("META");csp.setAttribute("http-equiv","Content-Security-Policy"),csp.setAttribute("content","script-src 'none'"),win.document.head.appendChild(csp)}()}),ed.onPreInit.add(function(){var attrRegExp=new RegExp("^data-mce-mt-"),placeholder='javascript:void("mce-mt-event-placeholer");return false';ed.parser.addAttributeFilter([/^on|action/],function(nodes,name){var i,node,internalName="data-mce-mt-"+name;for(i=0;i<nodes.length;i++)(node=nodes[i]).attr(internalName,node.attr(name)),node.attr(name,placeholder)}),ed.serializer.addAttributeFilter([attrRegExp],function(nodes,internalName){var i,node,savedValue,attrValue,name=internalName.substring("data-mce-mt-".length);for(i=0;i<nodes.length;i++)attrValue=(node=nodes[i]).attr(name),savedValue=node.attr(internalName),attrValue===placeholder&&(savedValue&&0<savedValue.length||(savedValue=null),node.attr(name,savedValue)),node.attr(internalName,null)}),ed.parser.addNodeFilter("#comment,#cdata",function(nodes,name){var i,node;for(i=0;i<nodes.length;i++)(node=nodes[i]).value=escape(node.value)}),ed.serializer.addNodeFilter("#comment",function(nodes,name){var i,node;for(i=0;i<nodes.length;i++)(node=nodes[i]).value=unescape(node.value),0===node.value.indexOf("[CDATA[")&&(node.name="#cdata",node.type=4,node.value=node.value.replace(/^\[CDATA\[|\]\]$/g,""))}),ed.parser.addNodeFilter("link,meta",function(nodes,name){var i;for(i=0;i<nodes.length;i++)nodes[i].remove()})}),ed.settings.plugin_mt_tainted_input&&tinymce.isIE&&ed.onPreInit.add(function(){var valueRegExp=new RegExp("^mce-mt-");ed.parser.addNodeFilter("link",function(nodes,name){var i,node;for(i=0;i<nodes.length;i++)node=nodes[i],$.each(["type","rel"],function(i,k){var value=node.attr(k);value&&node.attr(k,"mce-mt-"+value)})}),ed.parser.addNodeFilter("style",function(nodes,name){var i,node;for(i=0;i<nodes.length;i++)(node=nodes[i]).attr("type","mce-mt-"+(node.attr("type")||"text/css"))}),ed.serializer.addNodeFilter("link,style",function(nodes,name){var i,node;for(i=0;i<nodes.length;i++)node=nodes[i],$.each(["type","rel"],function(i,k){var value=node.attr(k);value&&node.attr(k,value.replace(valueRegExp,""))})}),ed.parser.addAttributeFilter("style",function(nodes,name){var i,node,internalName="data-mce-mtie-"+name;for(i=0;i<nodes.length;i++)(node=nodes[i]).attr(internalName,node.attr(name)),node.attr(name,"-mt-placeholder:auto;")}),ed.serializer.addAttributeFilter("data-mce-mtie-style",function(nodes,internalName){var i,node,savedValue,attrValue,name=internalName.substring("data-mce-mtie-".length);for(i=0;i<nodes.length;i++)attrValue=(node=nodes[i]).attr(name),savedValue=node.attr(internalName),"-mt-placeholder:auto;"===attrValue&&(savedValue&&0<savedValue.length||(savedValue=null),node.attr(name,savedValue)),node.attr(internalName,null)})}),this._setupExplicitButtonActivation(ed),this._setupIframeStatus(ed),ed.addCommand("mtGetStatus",function(){return ed.mtEditorStatus}),ed.addCommand("mtSetStatus",function(status){$.extend(ed.mtEditorStatus,status),updateButtonVisibility()}),ed.addCommand("mtGetProxies",function(){return proxies}),ed.addCommand("mtSetProxies",function(_proxies){$.extend(proxies,_proxies)}),ed.addCommand("mtRestoreBookmark",function(bookmark){(bookmark=bookmark||savedBookmark)&&ed.selection.moveToBookmark(savedBookmark)}),ed.addCommand("mtSaveBookmark",function(){return savedBookmark=ed.selection.getBookmark()}),$(window).bind("dialogDisposed",function(){savedBookmark&&ed.selection.moveToBookmark(savedBookmark),savedBookmark=null}),ed.addButton("mt_insert_html",{title:"mt.insert_html",onclick:function(){ed.windowManager.open({file:url+"/insert_html.html",width:430,height:345,inline:1},{plugin_url:url})}}),ed.addMTButton("mt_insert_image",{title:"mt.insert_image",onclick:function(){ed.execCommand("mtSaveBookmark"),openDialog("dialog_asset_modal","_type=asset&amp;edit_field="+id+"&amp;blog_id="+blogId+"&amp;dialog_view=1&amp;filter=class&amp;filter_val=image&amp;can_multi=1")}}),ed.addMTButton("mt_insert_file",{title:"mt.insert_file",onclick:function(){ed.execCommand("mtSaveBookmark"),openDialog("dialog_asset_modal","_type=asset&amp;edit_field="+id+"&amp;blog_id="+blogId+"&amp;dialog_view=1&amp;can_multi=1")}}),ed.addMTButton("mt_source_bold",{title:"mt.source_bold",text:"strong",mtButtonClass:"text",onclickFunctions:{source:"bold"}}),ed.addMTButton("mt_source_italic",{title:"mt.source_italic",text:"em",mtButtonClass:"text",onclickFunctions:{source:"italic"}}),ed.addMTButton("mt_source_blockquote",{title:"mt.source_blockquote",text:"blockquote",mtButtonClass:"text",onclickFunctions:{source:"blockquote"}}),ed.addMTButton("mt_source_unordered_list",{title:"mt.source_unordered_list",text:"ul",mtButtonClass:"text",onclickFunctions:{source:"insertUnorderedList"}}),ed.addMTButton("mt_source_ordered_list",{title:"mt.source_ordered_list",text:"ol",mtButtonClass:"text",onclickFunctions:{source:"insertOrderedList"}}),ed.addMTButton("mt_source_list_item",{title:"mt.source_list_item",text:"li",mtButtonClass:"text",onclickFunctions:{source:"insertListItem"}}),ed.addMTButton("mt_source_link",{title:"mt.insert_link",onclickFunctions:{source:function(cmd,ui,val){tinymce._setActive(ed),this.theme._mceLink.apply(this.theme),setPopupWindowLoadedHook(mtSourceLinkDialog)}}}),ed.addMTButton("mt_source_template",{title:"template.desc",onclickFunctions:{source:function(cmd,ui,val){tinymce._setActive(ed),ed.execCommand("mceTemplate"),setPopupWindowLoadedHook(mtSourceTemplateDialog)}}}),ed.addMTButton("mt_source_mode",{title:"mt.source_mode",onclickFunctions:{wysiwyg:function(){ed.execCommand("mtSetFormat","none.tinymce_temp")},source:function(){ed.execCommand("mtSetFormat","richtext")}}}),ed.onMTSourceButtonClick||(ed.onMTSourceButtonClick=new tinymce.util.Dispatcher(ed)),ed.onMTSourceButtonClick.add(updateSourceButtonState),ed.onNodeChange.add(function(ed,cm,n,co,ob){ed.mtEditorStatus;"source"==ed.mtEditorStatus.mode&&"none.tinymce_temp"!=ed.mtEditorStatus.format?$("#"+id+"_mt_source_mode").css("display","none"):$("#"+id+"_mt_source_mode").css("display","");var active="source"==ed.mtEditorStatus.mode&&"none.tinymce_temp"==ed.mtEditorStatus.format;cm.setActive("mt_source_mode",active),ed.mtProxies.source&&updateSourceButtonState(ed,ed.controlManager)})},createControl:function(name,cm){var ctrl=cm.editor.buttons[name];if("mt_insert_image"==name||"mt_insert_file"==name){this.buttonIDs[name]||(this.buttonIDs[name]=[]);var id=name+"_"+this.buttonIDs[name].length;return this.buttonIDs[name].push(id),cm.createButton(id,$.extend({},ctrl,{"class":"mce_"+name}))}if(ctrl&&ctrl.mtButtonClass){var button,buttonClass,escapedButtonClass;switch(ctrl.mtButtonClass){case"text":buttonClass=tinymce.ui.MTTextButton;break;default:throw new Error("Not implemented:"+ctrl.mtButtonClass)}return cm._cls.button&&(escapedButtonClass=cm._cls.button),cm._cls.button=buttonClass,button=cm.createButton(name,$.extend({},ctrl)),"undefined"!==escapedButtonClass&&(cm._cls.button=escapedButtonClass),button}return null},getInfo:function(){return{longname:"MovableType",author:"Six Apart Ltd",authorurl:"",infourl:"",version:"1.0"}}}),tinymce.PluginManager.add("mt",tinymce.plugins.MovableType)}(jQuery);