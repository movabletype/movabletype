<mt:setvarblock name="page_title"><__trans phrase="Reduce Revisions"></mt:setvarblock>
<mt:setvar name="position_actions_bottom" value="1">

<mt:setvarblock name="page_content">

<mt:if name="warnings">
  <mtapp:statusmsg
     id="generic-error"
     class="danger"
     can_close="0">
    <ul class="mb-0 ps-5">
    <mt:loop name="warnings">
        <li><mt:var name="__value__" escape="html"></li>
    </mt:loop>
    </ul>
  </mtapp:statusmsg>
</mt:if>
<mt:if name="saved">
  <mtapp:statusmsg
     id="saved"
     class="success">
    <__trans phrase="Reduce revisions jobs are being registered. This job will be executed in next run-periodic-tasks execution.">
  </mtapp:statusmsg>
</mt:if>

<p class="page-desc">
<__trans phrase="As you use Movable Type for a long time, the update history of articles and content data will increase, and the database will become bloated.Database bloat can be one of the reasons that processes such as Movable Type upgrades time out and fail.This function allows you to diagnose whether the revisions stored in the database exceeds the currently set limit, and if so, delete the target data.<br>Please note that deleting the revisions will make it impossible to track changes, so please be careful when making this decision.">
</p>

<div id="reduce-revisions-panel">
  <form id="reduce-revisions-form" method="post" action="<mt:var name="script_url">">
    <input type="hidden" name="__mode" value="reduce_revisions" />
    <input type="hidden" name="magic_token" value="<mt:var name="magic_token">" />

    <mtapp:setting
       id="reduce_revisions_what"
       label="<__trans phrase="What to reduce revisions">">
      <div>
        <input type="hidden" id="selected_blog_ids" name="reduce_revisions_what" value="" />
        <span id="selected_blogs"><__trans phrase="Everything"></span>
        <span id="selected_blogs_link" style="display: none;"><a href="javascript:void(0);" onclick="document.getElementById('selected_blogs_link').style.display='none';var e=document.getElementById('selected_blogs');e.innerHTML='<__trans phrase="Everything" escape="js">';document.getElementById('selected_blog_ids').value='';return false;"><__trans phrase="Reset"></a> |</span>
        <a href="<mt:var name="script_url">?__mode=dialog_select_website&amp;multi=1&amp;idfield=selected_blog_ids&amp;namefield=selected_blogs" class="mt-open-dialog mt-modal-open" data-mt-modal-large>
          <__trans phrase="Choose sites...">
        </a>
      </div>
    </mtapp:setting>
    <mtapp:setting
       id="target-objects"
       label="<__trans phrase="Target objects">">
      <ul id="target-objects-list" class="list-unstyled setting-list">
        <li>
          <div class="form-check">
            <input type="checkbox" name="target_entry" id="target-entry" class="form-check-input">
            <label class="form-check-label" for="target-entry"><__trans phrase="Entry"></label>
          </div>
        </li>
        <li>
          <div class="form-check">
            <input type="checkbox" name="target_cd" id="target-cd" class="form-check-input">
            <label class="form-check-label" for="target-cd"><__trans phrase="Content Data"></label>
          </div>
        </li>
        <li>
          <div class="form-check">
            <input type="checkbox" name="target_template" id="target-template" class="form-check-input">
            <label class="form-check-label" for="target-template"><__trans phrase="Template"></label>
          </div>
        </li>
        <li>
          <div class="form-check">
            <input type="checkbox" name="target_global_template" id="target-global-template" class="form-check-input">
            <label class="form-check-label" for="target-global-template"><__trans phrase="Global Template"></label>
          </div>
        </li>
      </ul>
    </mtapp:setting>
    <mtapp:setting
       id="revisions-date-range"
       label="<__trans phrase="Date Range">">
       <p>
         <div class="form-check">
           <input type="checkbox" name="use_filter_date" id="filter-date" class="form-check-input" value="1">
           <label class="form-check-label" for="filter-date"><__trans phrase="Filter revisions by date"></label>
         </div>
       </p>
       <div class="item-content form-inline" id="date-options">
         <__trans phrase="Revision created is before [_1]"
                  params="<input type="text" name="filter_date" class="form-control m-1 text-date text date" id="date-range">">
       </div>
    </mtapp:setting>

    <mt:setvarblock name="action_buttons">
      <button
         id="detect"
         type="submit" <mt:if name="warnings">disabled="disabled"</mt:if>
         title="<__trans phrase="Detect">"
         class="action primary button btn btn-primary">
        <__trans phrase="Detect">
      </button>
      <button
         id="delete"
         type="submit" <mt:if name="warnings">disabled="disabled"</mt:if>
         title="<__trans phrase="Delete">"
         class="action primary button btn btn-default">
        <__trans phrase="Delete">
      </button>
    </mt:setvarblock>
    <mt:include name="include/actions_bar.tmpl" bar_position="bottom" hide_pager="1" settings_bar="1">
  </form>
  <div id="print-detection"></div>
</div>
</mt:setvarblock>

<mt:setvarblock name="jq_js_include" append="1">
jQuery(function() {
  jQuery('#date-options').hide();
  jQuery('#delete').attr('disabled', 'disabled');
  jQuery('#detect').attr('disabled', 'disabled');

  jQuery('#target-objects-field input[type="checkbox"]').on('change', function() {
    if (jQuery('#target-objects-field input[type="checkbox"]:checked').length > 0) {
      console.log('checked');
      jQuery('#delete').removeAttr('disabled');
      jQuery('#detect').removeAttr('disabled');
    } else {
      jQuery('#delete').attr('disabled', 'disabled');
      jQuery('#detect').attr('disabled', 'disabled');
    }
  });

  jQuery('#filter-date').on('click', function() {
    if ( jQuery(this).is(':checked') ) {
      jQuery('#date-options').show();
    } else {
      jQuery('#date-options').hide();
    }
  });

  jQuery('#detect').on('click', function() {
    if (!jQuery('#date-range').mtValidate('simple')) {
      return false;
    }
    const inputData = $('#reduce-revisions-form').serialize();
    const data = inputData.replace(/reduce_revisions/, 'detect_reduce_revisions');
    jQuery.ajax({
      type: 'POST',
      contentType: 'application/x-www-form-urlencoded; charset=utf-8',
      url: ScriptURI,
      dataType: 'json',
      data: data,
      success: function(result) {
        jQuery('#print-detection').empty();
        jQuery('#detect').attr('disabled', 'disabled');
        let container = `<div class="h4"><__trans phrase="Detection Results"></div>`;
        container += '<ul>';
        for (const target of result['result']) {
            container += '<li>';
            // trans('Content Data');
            // trans('Entry');
            // trans('Global Template');
            // trans('Template');
            container += `${target['blogName']} ${trans(target['dsLabel'])}`;
            if (target['result'].length > 0) {
              container += '<ul>';
              for (const res of target['result']) {
                container += '<li>';
                if (jQuery('input[name="use_filter_date"]:checked').length > 0) {
                  container += `<__trans phrase="Violation detected">(${res['count']} <__trans phrase="revisions">)`;
                } else {
                  container += `<__trans phrase="Violation detected">(${res['count']}/${target['max']} <__trans phrase="revisions">)`;
                }
                const url = new URL(window.location.href);
                url.search = '';
                container += ` id=<a target="_blank" href="${url.toString()}?__mode=view&_type=${target['ds']}&blog_id=${target['blogId']}&id=${res['id']}">${res['id']}</a>`;
                container += '</li>';
              }
              container += '</ul>';
            } else {
              container += ' - <span>OK</span>';
            }
            container += '</li>';
        }
        container += '</ul>';
        jQuery('#print-detection').append(container);
        jQuery('#detect').removeAttr('disabled');
      },
      error: function(xhr, status) {
        if ( xhr.status == 401 ) {
          loginAgain(function(){
            $this.trigger('click');
          });
        } else {
          alert('Ajax error: ' + status);
        }
      }
    });
    return false;
  });

  jQuery('#delete').on('click', function() {
    if (!jQuery('#date-range').mtValidate('simple')) {
      return false;
    }
  });
});

function loginAgain(fn) {
  jQuery(window)
    .off('dialogReady.loginAgain')
    .on('dialogReady.loginAgain', function(){
      var dialog = jQuery('#mt-dialog-iframe').contents();
      dialog
        .find('#sign-in-button')
          .text('<__trans phrase="Continue" escape="js">')
          .off()
          .on('click', function(){
            dialog.find('#msg-block').empty();
            jQuery.ajax({
              type: 'POST',
              contentType: 'application/x-www-form-urlencoded; charset=utf-8',
              url: '<mt:var name="script_url">',
              dataType: 'json',
              data: {
                __mode: 'login_json',
                username: dialog.find('#username').val(),
                password: dialog.find('#password').val()
              },
              success: function(data) {
                var token = data.result['magic_token'];
                if (token) {
                  jQuery('input[name="magic_token"]').val(token);
                  jQuery('a[href*="magic_token="]').each(function() {
                    var replace = jQuery(this)
                      .attr('href')
                      .replace(/magic_token=[\d\w]+/, 'magic_token=' + token);
                    jQuery(this).attr('href', replace);
                  });
                }
                jQuery.fn.mtModal.close();
                fn(data);
                return false;
              },
              error: function(data) {
                dialog.find('#password').val('');
                dialog
                  .find('#msg-block')
                  .append('<div class="msg msg-error"><__trans phrase="Invalid login." escape="js"></div>');
              }
            });
            return false;
          });
    });
  jQuery.fn.mtModal.open(
    '<mt:var name="script_url">?__mode=dashboard',
    { large: true }
  );
}
</mt:setvarblock>
<mt:include name="layout/default.tmpl">
<mt:var name="layout">
