<mt:setvarblock name="page_title"><__trans phrase="Import Sites"></mt:setvarblock>
<mt:setvar name="restore" value="1">

<mt:setvarblock name="css_include" append="1">
<style type="text/css">
.mt-mainContent .hidden {
    display: none;
}
</style>
</mt:setvarblock>

<mt:include name="layout/common/header.tmpl">

<div class="row">
    <mt:if name="has_menu">
        <mt:include name="include/primary_navigation.tmpl">
    </mt:if>

    <div class="mt-mainContent" style="overflow: hidden;">
        <mt:include name="include/breadcrumbs.tmpl">
        <mt:include name="include/page_title.tmpl">

        <div class="import-process">
            <div id="progressbar" class="mt-progress mb-3">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" data-role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
            <div class="card card-block">
                <pre class="pre-scrollable progress-log p-3"><code><__trans phrase="Importing Movable Type"></code></pre>
            </div>
        </div>

        <div class="result success hidden">
            <h2><__trans phrase="All data imported successfully!"></h2>
            <mt:unless name="restore_upload">
                <p><__trans phrase="Make sure that you remove the files that you imported from the 'import' folder, so that if/when you run the import process again, those files will not be re-imported."></p>
            </mt:unless>
        </div>
        <div class="result error hidden">
            <mtapp:statusmsg id="error" class="danger" can_close="0">
                <__trans phrase="An error occurred during the import process: [_1] Please check activity log for more details." params="">
            </mtapp:statusmsg>
        </div>
    </div>
</div>

<script>
(function($){
    var progress = $(".progress-log");
    var tid = setInterval(function(){
        $.ajax({
            type: 'GET',
            url: '<mt:var name="script_url" escape="js">?__mode=restore_result',
            dataType: 'json'
        }).done(function(json) {
            var data = json.result;
            data.progress.forEach(function(e, i){
                var div = e.id ? progress.find(".id" + e.id) : null;
                if (div && div.length) {
                    div.text(e.message);
                } else {
                    var div2 = $("<div/>").text(e.message);
                    if (e.id) {
                        div2.addClass("id" + e.id);
                    }
                    progress.append(div2);
                }
            });

            if (data.done == '1' || json.error) {
                clearInterval(tid);
                $("#progressbar").addClass('hidden');
                $(json.error || data.error ? ".result.error" : ".result.success").removeClass("hidden");
                window.RestoredAssetIds = data.asset_ids;
                if (data.dialog_params) {
                    jQuery.fn.mtModal.open(
                        '<mt:var name="script_url" escape="js">?' + data.dialog_params,
                        { large: true }
                    );
                }
            }
        }).fail(function(jqXHR, textStatus, errorThrown){
            console.error(jqXHR, textStatus, errorThrown);
        });
    }, 5000);
})(jQuery);
</script>

<mt:include name="layout/common/footer.tmpl">
