#!/usr/bin/perl -w

# Movable Type (r) Open Source (C) 2001-2013 Six Apart, Ltd.
# This program is distributed under the terms of the
# GNU General Public License, version 2.
#
# $Id$

use warnings;
use strict;

use lib qw(lib extlib);
use MT;
use MT::App::API;

print <<__JS__;
/*
 * Do not edit this file manually.
 * This file is generated by "@{[ $0 ]}".
 */
(function(window) {


__JS__

my $mt = MT::App::API->new;
my $endpoints_list = $mt->registry( 'applications', 'api', 'endpoints' );
foreach my $endpoints (@$endpoints_list) {
    foreach my $e (@$endpoints) {
        my $func = $e->{id};
        $func =~ s/_(\w)/uc($1)/ge;
        my @vars = ();
        while ($e->{route} =~ /:([a-zA-Z_-]+)/g) {
            push @vars, $1;
        }

        my @resources = ();
        for my $name (@{ $e->{resources} || [] }) {
            push @resources, $name;
        }

        my $url;
        if (@vars) {
            $url = <<__JS__;
        this.bindEndpointParams('$e->{route}', {
            @{[ join(",\n            ", map {"$_: $_"} @vars) ]}
        })
__JS__
        }
        else {
            $url = <<__JS__;
        '$e->{route}'
__JS__
        }
        chomp($url);

        my $resources_str = '';
        if (@resources) {
            $resources_str = <<__JS__;
.concat([
        {
            @{[ join(",\n            ", map {"$_: $_"} @resources) ]}
        }
    ])
__JS__
        }
        chomp($resources_str);

        my $method = $e->{method} || 'GET';

        print <<__JS__;
window.MT.API.prototype.$func = function(@{[ join(', ', @vars, @resources) ]}) {
    var args = Array.prototype.slice.call(arguments, @{[ @vars + @resources ]});
    return this.request.apply(this, [
        '$method',
$url
    ].concat(args)$resources_str);
}

__JS__
    }
}

print <<__JS__;

})(window);
__JS__
