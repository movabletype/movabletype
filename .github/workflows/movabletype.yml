name: movabletype/movabletype
on:
  push:
    branches:
    - "**/*"
  pull_request:
  schedule:
    - cron:  '30 0 * * *'
concurrency:
#   # This item has no matching transformer
#   maximum_number_of_builds: 0
  group: "${{ github.ref }}"
  cancel-in-progress: true
env:
  MT_TEST_IGNORE_FIXTURE: '0'
  DOCKER_USERNAME: "${{ secrets.DOCKER_USERNAME }}"
  DOCKER_PASSWORD: "${{ secrets.DOCKER_PASSWORD }}"
jobs:
  test:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib t/*.t
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_mt7:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib t/mt7/[^t]*
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_mt7_tag:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib t/mt7/t*
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_others:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib t/admin_theme_id/ t/app/ t/class/ t/cms/ t/model/ t/mt_object/ t/object_driver/ t/task/ t/template/ t/tools t/util/
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_cms_permission:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib t/cms_permission/
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_data_api:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib t/data_api/
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_tag:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib t/tag/
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_plugins:
    strategy:
      matrix:
        distribution:
          - fedora40
          - fedora39
          - fedora37
          - fedora35
          - centos6
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib plugins/*/t
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_php_lint:
    strategy:
      matrix:
        distribution:
          - fedora39
          - fedora35
          - bullseye
          - buster
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: ${{ matrix.distribution }}
      TEST_COMMAND: phpunit && make test-php-lint
      DEFAULT_TARGET: ${{ (matrix.distribution == 'fedora39') && (github.event_name != 'schedule') }}
      OPTIONAL_TARGET: ${{ (matrix.distribution != 'fedora39') && (((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron')) }}
    if: ${{ env.DEFAULT_TARGET || env.OPTIONAL_TARGET }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  selenium_test:
    runs-on: ubuntu-20.04
    env:
      TEST_COMMAND: MT_TEST_SELENIUM_MAX_RETRY=5 prove -v -j1 -PMySQLPool=MT::Test::Env -It/lib t/selenium/*.t
      TEST_IMAGE_NAME: chromiumdriver
    if: ${{ github.event_name != 'schedule' }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  selenium_crawl_test:
    runs-on: ubuntu-20.04
    env:
      TEST_COMMAND: MT_TEST_SELENIUM_MAX_RETRY=5 MT_TEST_CRAWL=1 prove -j1 -PMySQLPool=MT::Test::Env -It/lib t/selenium/crawl.t
      TEST_IMAGE_NAME: chromiumdriver
    if: ${{ ((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron') }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  test_xt:
    runs-on: ubuntu-20.04
    env:
      TEST_IMAGE_NAME: buster
      TEST_COMMAND: prove -j4 -PMySQLPool=MT::Test::Env -It/lib xt
    if: ${{ ((github.event_name == 'schedule') && ((github.ref == 'refs/heads/master') || contains(github.ref, '/develop') || contains(github.ref, '/support-') || contains(github.ref, '/release-'))) || contains(github.ref, 'cron') }}
    steps:
    - name: checkout
      uses: actions/checkout@v4.1.0
    - run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:fedora39 bash -c "BUILD_RELEASE_NUMBER=1 make"
    - run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "$TEST_COMMAND"
  notify_slack:
    runs-on: ubuntu-20.04
    needs:
    - test
    - test_mt7
    - test_mt7_tag
    - test_others
    - test_cms_permission
    - test_data_api
    - test_tag
    - test_plugins
    - test_php_lint
    - selenium_test
    - selenium_crawl_test
    - test_xt
    if: ${{ always() }}
    steps:
    - name: Install jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
    - name: Filters if the "needs" context has "failure"
      run: |
        HAS_FAILURE=$(echo '${{ toJSON(needs) }}' | jq '.[] | select(.result == "failure").result')
        echo "HAS_FAILURE=${HAS_FAILURE}" >> "$GITHUB_ENV"
    - name: SLACK_COLOR is danger
      if: ${{ env.HAS_FAILURE }}
      run: |
        echo "SLACK_COLOR=danger" >> "$GITHUB_ENV"
    - name: SLACK_COLOR is good
      if: ${{ ! env.HAS_FAILURE }}
      run: |
        echo "SLACK_COLOR=good" >> "$GITHUB_ENV"
    - uses: rtCamp/action-slack-notify@v2.2.1
      env:
        SLACK_WEBHOOK: "${{ secrets.SLACK_WEBHOOK }}"
        SLACK_USERNAME: "GitHub Actions ${{ github.repository }}"
        SLACK_TITLE: 'Workflow #${{ github.run_number }}'
        SLACK_ICON: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
        SLACK_COLOR: "${{ env.SLACK_COLOR }}"
