name: movabletype/movabletype
on:
  push:
    branches:
    - "**/*"
  pull_request:
  schedule:
    - cron:  '30 0 * * *'
concurrency:
#   # This item has no matching transformer
#   maximum_number_of_builds: 0
  group: "${{ github.ref }}"
  cancel-in-progress: true
env:
  MT_TEST_IGNORE_FIXTURE: '0'
  DOCKER_USERNAME: "${{ secrets.DOCKER_USERNAME }}"
  DOCKER_PASSWORD: "${{ secrets.DOCKER_PASSWORD }}"
jobs:
  # Perl 5.38 / PHP 8.2 / MySQL 8.0
  fedora39:
    env:
      TEST_IMAGE_NAME: fedora39
    if: ${{ ( (github.event_name != 'schedule') || ( (github.repository == 'movabletype/movabletype' ) && (github.event_name == 'schedule') ) ) }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test:
          - php
    steps:
      - name: checkout
        uses: actions/checkout@v4.1.0
      - name: login
        run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
      - name: test
        if: ${{ (matrix.test != 'php' && matrix.test != 'selenium') }}
        run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "prove -lr -j4 -PMySQLPool=MT::Test::Env -It/lib ${{ matrix.test }}"
      - name: test selenium
        if: ${{ matrix.test == 'selenium' }}
        run: docker run -t -v $PWD:/mt -w /mt movabletype/test:chromiumdriver bash -c "MT_TEST_SELENIUM_MAX_RETRY=5 prove -lr -j1 -PMySQLPool=MT::Test::Env -It/lib t/selenium"
      - name: test php
        if: ${{ matrix.test == 'php' }}
        run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "phpunit && make test-php-lint"

  # Perl 5.38 / PHP 8.3 / MySQL 8.0
  fedora40:
    needs: [fedora39]
    if: ${{ ( ( (github.repository == 'movabletype/movabletype' ) && (github.event_name == 'schedule') ) || contains(github.head_ref, 'cron') ) }}
    runs-on: ubuntu-latest
    env:
      TEST_IMAGE_NAME: fedora40
    strategy:
      matrix:
        test:
          - php
    steps:
      - name: checkout
        uses: actions/checkout@v4.1.0
      - name: login
        run: docker login --username "$DOCKER_USERNAME" --password "$DOCKER_PASSWORD"
      - name: test
        if: ${{ matrix.test != 'php' }}
        run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "prove -lr -j4 -PMySQLPool=MT::Test::Env -It/lib ${{ matrix.test }}"
      - name: test php
        if: ${{ matrix.test == 'php' }}
        run: docker run -t -v $PWD:/mt -w /mt movabletype/test:$TEST_IMAGE_NAME bash -c "phpunit && make test-php-lint"
